@model BusSystem.Admin.Web.Models.MenuItemDto
@{
    ViewData["Title"] = "Edit Menu Item";
}

<partial name="_BackButton" />

<h1>Edit Menu Item</h1>
<form asp-action="Edit" method="post" asp-route-id="@Model.MenuItemId" enctype="multipart/form-data">
    <input type="hidden" asp-for="MenuItemId" />
    <input type="hidden" asp-for="Image" />
    <div class="mb-3">
        <label class="form-label">Category</label>
        <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.Categories" required></select>
    </div>
    <div class="mb-3">
        <label asp-for="Name" class="form-label">Name</label>
        <input asp-for="Name" class="form-control" required />
        <span asp-validation-for="Name" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Description" class="form-label">Description</label>
        <textarea asp-for="Description" class="form-control"></textarea>
    </div>
    <div class="mb-3">
        <label class="form-label">Current Image</label><br />
        <div id="currentImageContainer">
            @if(!string.IsNullOrWhiteSpace(Model.Image))
            {
                <div class="d-flex align-items-start gap-2 mb-2">
                    <img src="@Model.Image" 
                         alt="@Model.Name" 
                         loading="lazy" 
                         width="80" 
                         height="80" 
                         style="width:80px;height:80px;object-fit:cover;" 
                         class="rounded" 
                         id="currentImage" />
                    <button type="button" 
                            class="btn btn-danger btn-sm" 
                            id="deleteImageBtn"
                            title="Delete current image">
                        <i class="bi bi-trash"></i> Delete Image
                    </button>
                </div>
            }
            else
            {
                <p class="text-muted" id="noImageText">No image uploaded</p>
            }
        </div>
        <input type="file" name="imageFile" class="form-control mt-2" accept=".png,.jpg,.jpeg" />
    </div>
    <div class="mb-3">
        <label asp-for="Price" class="form-label">Price</label>
        <input asp-for="Price" class="form-control" type="number" step="0.01" required />
        <span asp-validation-for="Price" class="text-danger"></span>
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
    <a asp-action="Index" class="btn btn-secondary">Cancel</a>
</form>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const fileInput = document.querySelector('input[name="imageFile"]');
            if (fileInput) {
                fileInput.addEventListener('change', function () {
                    const allowedExt = ['png', 'jpg', 'jpeg'];
                    if (this.files.length) {
                        const ext = this.files[0].name.split('.').pop().toLowerCase();
                        if (!allowedExt.includes(ext)) {
                            alert('Only image files (.png, .jpg, .jpeg) are allowed.');
                            this.value = '';
                        }
                    }
                });
            }

            // Handle delete image button
            const deleteImageBtn = document.getElementById('deleteImageBtn');
            if (deleteImageBtn) {
                deleteImageBtn.addEventListener('click', function () {
                    if (confirm('Are you sure you want to delete this image?')) {
                        const menuItemId = @Model.MenuItemId;
                        
                        deleteImageBtn.disabled = true;
                        deleteImageBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Deleting...';
                        
                        fetch(`/MenuItemManagement/DeleteImage?id=${menuItemId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                document.getElementById('currentImageContainer').innerHTML = 
                                    '<p class="text-muted" id="noImageText">No image uploaded</p>';
                                document.querySelector('input[name="Image"]').value = '';
                                // alert('Image deleted successfully!');
                            } else {
                                alert('Failed to delete image: ' + (data.message || 'Unknown error'));
                                deleteImageBtn.disabled = false;
                                deleteImageBtn.innerHTML = '<i class="bi bi-trash"></i> Delete Image';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while deleting the image.');
                            deleteImageBtn.disabled = false;
                            deleteImageBtn.innerHTML = '<i class="bi bi-trash"></i> Delete Image';
                        });
                    }
                });
            }
        });
    </script>
}
